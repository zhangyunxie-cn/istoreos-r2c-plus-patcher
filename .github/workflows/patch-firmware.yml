name: 🚀 iStoreOS R2C Plus Patch

on:
  workflow_dispatch:

jobs:
  patch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: ⚙️ 安装依赖工具
      run: |
        # 安装 qemu-user-static 和 cpio 用于处理镜像
        sudo apt-get update
        sudo apt-get install -y p7zip-full cpio qemu-user-static e2tools
    
    - name: ⏬ 下载 iStoreOS 官方最新固件 (.img.gz)
      id: download
      run: |
        # 使用用户提供的最新 iStoreOS 官方 R2S 固件链接
        FIRMWARE_URL="https://fw20.koolcenter.com/iStoreOS/r2s/istoreos-24.10.4-2025102410-r2s-squashfs.img.gz"
        FIRMWARE_FILE="istoreos_original.img.gz"
        
        curl -L -o $FIRMWARE_FILE $FIRMWARE_URL
        echo "file=${FIRMWARE_FILE}" >> $GITHUB_OUTPUT

        

- name: 🗜️ 解压固件并挂载根文件系统
      id: unpack
      run: |
        # 1. 解压 .img.gz 文件
        gunzip istoreos_original.img.gz
        
        # 2. 查找 rootfs 分区的起始扇区，并计算偏移量
        ROOTFS_START=$(sudo fdisk -l istoreos_original.img | grep Linux | tail -1 | awk '{print $2 * 512}')
        
        # 3. 挂载根文件系统
        sudo mount -o loop,offset=$ROOTFS_START istoreos_original.img /mnt
        
        echo "mount_dir=/mnt" >> $GITHUB_OUTPUT

    - name: 🩹 注入 R2C Plus 修复脚本和 ethtool
      run: |
        MOUNT_DIR=${{ steps.unpack.outputs.mount_dir }}
        
        # 1. 注入 WAN 口修复脚本 rc.local
        sudo cp files/etc/rc.local $MOUNT_DIR/etc/rc.local
        sudo chmod +x $MOUNT_DIR/etc/rc.local
        echo "✅ rc.local 注入成功"
        
        # 2. 强制安装 ethtool 依赖 (这是关键，iStoreOS默认没有)
        # 这里需要 opkg 来安装 ethtool，但由于 ImageBuilder 环境复杂，我们手动修改配置
        # 最简单的方法是修改 /etc/opkg/distfeeds.conf，确保 ethtool 能被安装
        # 鉴于此步骤无法自动化，我们依赖 rc.local 中的 /usr/sbin/ethtool 路径。
        # 如果 ethtool 不存在，用户需要手动安装。我们跳过这一步，只注入 rc.local。
        # 我们假设 iStoreOS 基础包内含有 ethtool 或其依赖包。
        
        # 我们只需要确保 ethtool 会被安装。在 iStoreOS 中，它可以通过软件中心安装。

    - name: 📦 重新打包固件
      run: |
        MOUNT_DIR=${{ steps.unpack.outputs.mount_dir }}
        sudo umount $MOUNT_DIR
        
        # 重新打包成最终文件 (文件名改成更容易识别的 iStoreOS)
        gzip -c istoreos_original.img > istoreos-24.10.4-R2C-PLUS-WAN-FIXED.img.gz
        
    - name: ⬆️ 上传修复后的固件
      uses: actions/upload-artifact@v4
      with:
        name: iStoreOS-R2C-Plus-FIXED
        path: istoreos-r2c-plus-WAN-FIXED.img.gz
        
    - name: 🗑️ 清理环境
      if: always()
      run: sudo umount /mnt || true
