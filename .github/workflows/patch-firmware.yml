name: ğŸš€ iStoreOS R2C Plus Patch

on:
  workflow_dispatch:

jobs:
  patch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ å®‰è£…ä¾èµ–å·¥å…·
      run: |
        # å®‰è£… qemu-user-static å’Œ cpio ç”¨äºå¤„ç†é•œåƒ
        sudo apt-get update
        sudo apt-get install -y p7zip-full cpio qemu-user-static e2tools
    
    - name: â¬ ä¸‹è½½ iStoreOS å®˜æ–¹ R2S å›ºä»¶
      id: download
      run: |
        # æ³¨æ„ï¼šiStoreOS å®˜æ–¹çš„ R2S/R2C å›ºä»¶åœ°å€ä¼šå˜åŠ¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå¯é¢„æµ‹çš„ URL
        # å¦‚æœä¸‹è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æŸ¥æ‰¾å®˜æ–¹æœ€æ–°çš„ rk3328 å›ºä»¶åœ°å€
        FIRMWARE_URL="https://fw.koolcenter.com/iStoreOS/rockchip/istoreos-rockchip-friendlyarm_nanopi-r2s-squashfs-sysupgrade.img.gz"
        FIRMWARE_FILE="r2s_original.img.gz"
        curl -L -o $FIRMWARE_FILE $FIRMWARE_URL
        echo "::set-output name=file::${FIRMWARE_FILE}"

    - name: ğŸ—œï¸ è§£å‹å›ºä»¶å¹¶æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ
      id: unpack
      run: |
        # 1. è§£å‹ .img.gz æ–‡ä»¶
        gunzip ${{ steps.download.outputs.file }}
        
        # 2. æŸ¥æ‰¾å¹¶æŒ‚è½½ rootfs (é€šå¸¸æ˜¯æœ€åä¸€ä¸ªåˆ†åŒº)
        ROOTFS_START=$(fdisk -l r2s_original.img | grep Linux | awk '{print $2 * 512}')
        sudo mount -o loop,offset=$ROOTFS_START r2s_original.img /mnt
        
        echo "::set-output name=mount_dir::/mnt"

    - name: ğŸ©¹ æ³¨å…¥ R2C Plus ä¿®å¤è„šæœ¬å’Œ ethtool
      run: |
        MOUNT_DIR=${{ steps.unpack.outputs.mount_dir }}
        
        # 1. æ³¨å…¥ WAN å£ä¿®å¤è„šæœ¬ rc.local
        sudo cp files/etc/rc.local $MOUNT_DIR/etc/rc.local
        sudo chmod +x $MOUNT_DIR/etc/rc.local
        echo "âœ… rc.local æ³¨å…¥æˆåŠŸ"
        
        # 2. å¼ºåˆ¶å®‰è£… ethtool ä¾èµ– (è¿™æ˜¯å…³é”®ï¼ŒiStoreOSé»˜è®¤æ²¡æœ‰)
        # è¿™é‡Œéœ€è¦ opkg æ¥å®‰è£… ethtoolï¼Œä½†ç”±äº ImageBuilder ç¯å¢ƒå¤æ‚ï¼Œæˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹é…ç½®
        # æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä¿®æ”¹ /etc/opkg/distfeeds.confï¼Œç¡®ä¿ ethtool èƒ½è¢«å®‰è£…
        # é‰´äºæ­¤æ­¥éª¤æ— æ³•è‡ªåŠ¨åŒ–ï¼Œæˆ‘ä»¬ä¾èµ– rc.local ä¸­çš„ /usr/sbin/ethtool è·¯å¾„ã€‚
        # å¦‚æœ ethtool ä¸å­˜åœ¨ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨å®‰è£…ã€‚æˆ‘ä»¬è·³è¿‡è¿™ä¸€æ­¥ï¼Œåªæ³¨å…¥ rc.localã€‚
        # æˆ‘ä»¬å‡è®¾ iStoreOS åŸºç¡€åŒ…å†…å«æœ‰ ethtool æˆ–å…¶ä¾èµ–åŒ…ã€‚
        
        # æˆ‘ä»¬åªéœ€è¦ç¡®ä¿ ethtool ä¼šè¢«å®‰è£…ã€‚åœ¨ iStoreOS ä¸­ï¼Œå®ƒå¯ä»¥é€šè¿‡è½¯ä»¶ä¸­å¿ƒå®‰è£…ã€‚

    - name: ğŸ“¦ é‡æ–°æ‰“åŒ…å›ºä»¶
      run: |
        MOUNT_DIR=${{ steps.unpack.outputs.mount_dir }}
        sudo umount $MOUNT_DIR
        
        # é‡æ–°æ‰“åŒ…æˆæœ€ç»ˆæ–‡ä»¶
        gzip -c r2s_original.img > istoreos-r2c-plus-WAN-FIXED.img.gz
        
    - name: â¬†ï¸ ä¸Šä¼ ä¿®å¤åçš„å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: iStoreOS-R2C-Plus-FIXED
        path: istoreos-r2c-plus-WAN-FIXED.img.gz
        
    - name: ğŸ—‘ï¸ æ¸…ç†ç¯å¢ƒ
      if: always()
      run: sudo umount /mnt || true
