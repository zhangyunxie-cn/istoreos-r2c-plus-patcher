name: ğŸš€ iStoreOS R2C Plus Patch

on:
  workflow_dispatch:

jobs:
  patch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ å®‰è£…ä¾èµ–å·¥å…·
      run: |
        # å®‰è£… qemu-user-static å’Œ cpio ç”¨äºå¤„ç†é•œåƒ
        sudo apt-get update
        sudo apt-get install -y p7zip-full cpio qemu-user-static e2tools
    
    - name: â¬ ä¸‹è½½ iStoreOS å®˜æ–¹æœ€æ–°å›ºä»¶ (.img.gz)
      id: download
      run: |
        # ä½¿ç”¨ç”¨æˆ·æä¾›çš„æœ€æ–° iStoreOS å®˜æ–¹ R2S å›ºä»¶é“¾æ¥
        FIRMWARE_URL="https://fw20.koolcenter.com/iStoreOS/r2s/istoreos-24.10.4-2025102410-r2s-squashfs.img.gz"
        FIRMWARE_FILE="istoreos_original.img.gz"
        
        curl -L -o $FIRMWARE_FILE $FIRMWARE_URL
        echo "file=${FIRMWARE_FILE}" >> $GITHUB_OUTPUT

        

- name: ğŸ—œï¸ è§£å‹å›ºä»¶å¹¶æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ
      id: unpack
      run: |
        # 1. è§£å‹ .img.gz æ–‡ä»¶
        gunzip istoreos_original.img.gz
        
        # 2. æŸ¥æ‰¾ rootfs åˆ†åŒºçš„èµ·å§‹æ‰‡åŒºï¼Œå¹¶è®¡ç®—åç§»é‡
        ROOTFS_START=$(sudo fdisk -l istoreos_original.img | grep Linux | tail -1 | awk '{print $2 * 512}')
        
        # 3. æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ
        sudo mount -o loop,offset=$ROOTFS_START istoreos_original.img /mnt
        
        echo "mount_dir=/mnt" >> $GITHUB_OUTPUT

    - name: ğŸ©¹ æ³¨å…¥ R2C Plus ä¿®å¤è„šæœ¬å’Œ ethtool
      run: |
        MOUNT_DIR=${{ steps.unpack.outputs.mount_dir }}
        
        # 1. æ³¨å…¥ WAN å£ä¿®å¤è„šæœ¬ rc.local
        sudo cp files/etc/rc.local $MOUNT_DIR/etc/rc.local
        sudo chmod +x $MOUNT_DIR/etc/rc.local
        echo "âœ… rc.local æ³¨å…¥æˆåŠŸ"
        
        # 2. å¼ºåˆ¶å®‰è£… ethtool ä¾èµ– (è¿™æ˜¯å…³é”®ï¼ŒiStoreOSé»˜è®¤æ²¡æœ‰)
        # è¿™é‡Œéœ€è¦ opkg æ¥å®‰è£… ethtoolï¼Œä½†ç”±äº ImageBuilder ç¯å¢ƒå¤æ‚ï¼Œæˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹é…ç½®
        # æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä¿®æ”¹ /etc/opkg/distfeeds.confï¼Œç¡®ä¿ ethtool èƒ½è¢«å®‰è£…
        # é‰´äºæ­¤æ­¥éª¤æ— æ³•è‡ªåŠ¨åŒ–ï¼Œæˆ‘ä»¬ä¾èµ– rc.local ä¸­çš„ /usr/sbin/ethtool è·¯å¾„ã€‚
        # å¦‚æœ ethtool ä¸å­˜åœ¨ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨å®‰è£…ã€‚æˆ‘ä»¬è·³è¿‡è¿™ä¸€æ­¥ï¼Œåªæ³¨å…¥ rc.localã€‚
        # æˆ‘ä»¬å‡è®¾ iStoreOS åŸºç¡€åŒ…å†…å«æœ‰ ethtool æˆ–å…¶ä¾èµ–åŒ…ã€‚
        
        # æˆ‘ä»¬åªéœ€è¦ç¡®ä¿ ethtool ä¼šè¢«å®‰è£…ã€‚åœ¨ iStoreOS ä¸­ï¼Œå®ƒå¯ä»¥é€šè¿‡è½¯ä»¶ä¸­å¿ƒå®‰è£…ã€‚

    - name: ğŸ“¦ é‡æ–°æ‰“åŒ…å›ºä»¶
      run: |
        MOUNT_DIR=${{ steps.unpack.outputs.mount_dir }}
        sudo umount $MOUNT_DIR
        
        # é‡æ–°æ‰“åŒ…æˆæœ€ç»ˆæ–‡ä»¶ (æ–‡ä»¶åæ”¹æˆæ›´å®¹æ˜“è¯†åˆ«çš„ iStoreOS)
        gzip -c istoreos_original.img > istoreos-24.10.4-R2C-PLUS-WAN-FIXED.img.gz
        
    - name: â¬†ï¸ ä¸Šä¼ ä¿®å¤åçš„å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: iStoreOS-R2C-Plus-FIXED
        path: istoreos-r2c-plus-WAN-FIXED.img.gz
        
    - name: ğŸ—‘ï¸ æ¸…ç†ç¯å¢ƒ
      if: always()
      run: sudo umount /mnt || true
